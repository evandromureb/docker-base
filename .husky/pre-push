#!/usr/bin/env sh
set -e

# Cores para feedback visual
NC='\033[0m'         # Sem cor
BBlue='\033[1;34m'   # Azul negrito
BRed='\033[1;31m'    # Vermelho negrito
BGreen='\033[1;32m'  # Verde negrito
BYellow='\033[1;33m' # Amarelo negrito

echo -e "${BBlue}Executando verifica√ß√µes pre-push...${NC}"

## Executar lint-staged
#echo -e "${BYellow}Executando lint-staged...${NC}"
#npx lint-staged
#if [ $? -ne 0 ]; then
#    echo -e "${BRed}‚ùå Falha ao executar lint-staged${NC}"
#    exit 1
#fi
#echo -e "${BGreen}‚úÖ lint-staged conclu√≠do com sucesso${NC}"

# Rodar o phpstan (descomentado e com tratamento de erro)
echo -e "${BYellow}Executando PHPStan...${NC}"
if [ -f "./vendor/bin/phpstan" ]; then
    ./vendor/bin/phpstan
    if [ $? -ne 0 ]; then
        echo -e "${BRed}‚ùå Falha na an√°lise do PHPStan. Por favor corrija os erros antes de continuar.${NC}"
        exit 1
    fi
    echo -e "${BGreen}‚úÖ PHPStan conclu√≠do com sucesso${NC}"
else
    echo -e "${BYellow}‚ö†Ô∏è PHPStan n√£o encontrado. Pulando verifica√ß√£o...${NC}"
fi

# Rodar os testes (descomentado e com tratamento de erro)
#echo -e "${BYellow}Executando testes...${NC}"
#if [ -f "./artisan" ]; then
#    php artisan test --parallel
#    if [ $? -ne 0 ]; then
#        echo -e "${BRed}‚ùå Falha nos testes. Por favor corrija os erros antes de continuar.${NC}"
#        exit 1
#    fi
#    echo -e "${BGreen}‚úÖ Testes conclu√≠dos com sucesso${NC}"
#else
#    echo -e "${BYellow}‚ö†Ô∏è Artisan n√£o encontrado. Pulando testes...${NC}"
#fi

# Formatar os arquivos PHP alterados usando Laravel Pint
echo -e "${BYellow}Formatando arquivos PHP alterados...${NC}"
if [ -f "./vendor/bin/pint" ]; then
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.php$") || true

    if [ -n "$STAGED_FILES" ]; then
        echo "$STAGED_FILES" | xargs ./vendor/bin/pint
        echo "$STAGED_FILES" | xargs git add
        echo -e "${BGreen}‚úÖ Arquivos formatados com Laravel Pint${NC}"
    else
        echo -e "${BYellow}‚ö†Ô∏è Nenhum arquivo PHP alterado para formatar${NC}"
    fi
else
    echo -e "${BYellow}‚ö†Ô∏è Laravel Pint n√£o encontrado. Pulando formata√ß√£o...${NC}"
fi

echo -e "${BGreen}üöÄ Todas as verifica√ß√µes conclu√≠das com sucesso!${NC}"
exit 0
